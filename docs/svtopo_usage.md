## SVTopo BAM parsing

### Quick Start
**Input:** The SVTopo utility requires phased HiFi BAM input. Phasing with [HiPhase](https://github.com/PacificBiosciences/HiPhase) is strongly recommended and results may be negatively impacted if a different phasing tool is used.

```
Usage: svtopo [OPTIONS] --bam <BAM>

Options:
  -b, --bam <BAM>             pbmm2-aligned BAM filename
  -p, --output-prefix <PATH>  Output prefix, which may begin with a directory path [default: ""]
      --verbose               Optional flag to print verbose output for debugging purposes
  -q, --quiet                 Optional flag to run in quiet mode (disable all logging). Overrides "--verbose"
      --no-filter             Optional flag to disable coverage depth and mapping quality filters. Use with caution as many low-confidence images may result
      --allow-unphased        Optional flag to include connections found using reads that are not haplotagged. This may results in lower-quality outputs
  -h, --help                  Print help
  -V, --version               Print version

Copyright (C) 2004-2024     Pacific Biosciences of California, Inc.
This program comes with ABSOLUTELY NO WARRANTY; it is intended for
Research Use Only and not for use in diagnostic procedures.```
```

**BAM parsing example**
Execution example (replace paths with your own):
```bash
svtopo --bam /path/to/reads.bam > /path/to/results.json
```

## Advanced usage
#### Setting a JSON prefix
The `--output-prefix` option allows users to pass in an explicit prefix for the JSON output, which may consist of a relative or absolute path and an optional file name prefix for the JSON output. If used, JSON output is written in gzipped format. For example, the following input `--prefix mydirectory/sample_id` will generate a JSON file `mydirectory/sample_id_svtopo.json.gz`. Note that the SVTopoVz step accepts either zipped or unzipped JSON inputs.

#### Allowing unphased connections
In some cases, regions of the genome may prove difficult to phase even with HiPhase. Alignments with mismatching or missing haplotags will be dropped by SVTopo by default, but with the `--allow-unphased` command-line option they are retained. This will generally increase the number of regions/images generated by SVTopo, at the cost of including more that have alignment issues and are uninterpretable. 

## Runtime and output
SVTopo was benchmarked with a 30x HiFi genome, in default mode and with the `--no-filter` option:

#### Default mode
* 91m42s run time
* 586 SV entries in JSON

#### No-filter mode
* 10m43s run time
* 838 SV entries in JSON

## Algorithm notes
* Clipped alignments: SVTopo uses chimeric/split alignments to identify signals of structural variation. These are defined as alignments with at least 100 bases of soft-clipping on either end of the alignment. Alignments with MAPQ < 20 are omitted.
* Break clusters: Locations of genomic breaks are identified using alignment clipping locations that are the same or nearly the same. These are defined as being within 10 bp of each other, allowing for small differences of alignment and minimal sequencing error. Break cluster positions are given from the middle of the clip sites among alignments within 10 bp.
* Phase filter: If the --allow-unphased option is not set, break clusters are only included if the phase if unambiguous. That is defined as having exactly one haplotype ID and one phaseset ID, with at least 2 phased alignments. Unphased alignments may also be included.
* Break connections: Once breaks are identified, they can be connected in pairwise fashion by alignments that are shared between them. A minimum of two such shared alignments is required to make a connection and they must be within 1 mb of each other.
* Phased connection of clusters: In some cases phasing is used to connect breaks locations instead of directly using spanning alignments. In these cases, the clusters must be within 500kb of each other, have the same phaseset ID, and be on the same haplotype.
* Ambiguous sample order: In some cases it may be impossible to determine the order of some genomic blocks. These are given the sample sample_order_index entry in JSON and plotted in images with red outlines.
* Regional quality filtering: Unless the `--no-filter` option is set, the following filters are applied:
  * Coverage of 500x or less
  * No more than 5% of reads below MAPQ of 5
* Graph warnings: If a complex event graph is built, but the graph construction process fails to identify an entry point for the graph (that is, no clear start to the complex rearrangement), the graph is not emitted.
