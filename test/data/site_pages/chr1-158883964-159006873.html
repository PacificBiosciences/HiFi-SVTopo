<!DOCTYPE html>
<html lang='en'>

<head>
    <meta charset='utf-8'>
    <title>SVTopo</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.9.2/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crossfilter2/1.4.7/crossfilter.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dc/3.0.12/dc.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js"
        type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.js" type="text/javascript"></script>
    <script src="https://cdn.datatables.net/v/bs4/dt-1.10.20/b-1.6.1/b-html5-1.6.1/sc-2.0.1/sl-1.3.1/datatables.min.js"
        type="text/javascript"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.5.0/viewer.min.css" rel="stylesheet"
        type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.8.2/css/all.min.css" rel="stylesheet"
        type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet"
        type="text/css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/dc/3.0.12/dc.min.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.datatables.net/v/bs4/dt-1.10.20/b-1.6.1/b-html5-1.6.1/sc-2.0.1/sl-1.3.1/datatables.min.css"
        rel="stylesheet" type="text/css" />

    <style type="text/css">
        #filter-menu .dropdown-menu {
            min-height: 100px;
            max-height: 100vh;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #edf0f2;
        }

        span.no-show {
            display: none;
        }

        span.show-ellipsis:after {
            content: "...";
        }

        .datatable-info {
            font-size: .9em;
        }

        #variant-table_info {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            padding: 10px;
            border-top: 1px solid #dee2e6;
            z-index: 1000;
        }

        /* Add padding to prevent table content from being hidden behind fixed info bar */
        #variant-table_wrapper {
            padding-bottom: 50px;
        }

        table.dataTable thead th.sorting:after,
        table.dataTable thead th.sorting_asc:after,
        table.dataTable thead th.sorting_desc:after,
        table.dataTable thead th.sorting:before,
        table.dataTable thead th.sorting_asc:before,
        table.dataTable thead th.sorting_desc:before {
            font-family: FontAwesome !important;
        }

        .modal-content {
            width: 610px;
        }

        h7 {
            font-size: .95rem;
        }

        body {
            height: 100vh
        }

        div.dts div.dataTables_scrollBody {
            background: white;
        }

        .dropdown {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            left: 0;
            top: 100%;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 8px 16px;
            text-decoration: none;
            display: block;
            color: black;
            cursor: pointer;
            white-space: nowrap;
        }

        .dropdown-item:hover {
            background-color: #f1f1f1;
        }

        /* Custom context menu styles */
        .custom-context-menu {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            min-width: 180px;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background-color: #f5f5f5;
        }

        /* Add hover indication for table rows */
        #variant-table tbody tr {
            cursor: pointer;
        }

        /* Success message for clipboard operations */
        .clipboard-success {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            z-index: 2000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            display: none;
        }

        .navbar {
            height: 120px;
            background: linear-gradient(to right,
                    #df1995,
                    /* Original pink */
                    #a80d6e,
                    /* Darker pink */
                    #df1995
                    /* Original pink */
                );
        }

        .github-link {
            margin-left: auto;
        }

        .navbar-center-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .navbar-brand {
            font-size: 4.5rem;
            /* Larger text for SVTopo title */
            display: flex;
            align-items: center;
        }

        .navbar-logo {
            height: 80px;
            /* Double the original logo height */
        }

        .github-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: white;
        }

        .github-container:hover {
            text-decoration: none;
            color: white;
        }

        .github-label {
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        .custom-control-label {
            font-size: 0.9em;
            padding-top: 2px;
        }

        .custom-checkbox {
            margin-top: 2px;
        }

        body.viewer-open {
            overflow: hidden;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark p-0 pl-2">
        <div class="navbar-center-container">
            <div class="navbar-brand text-light p-0">
                <img src="svtopo.png" class="navbar-logo d-inline-block mr-3" alt="SVTopo Logo">
                SVTopo
            </div>
        </div>
        <a class="github-link github-container pr-2" href="https://github.com/PacificBiosciences/HiFi-SVTopo"
            target="_blank">
            <img src="github-mark-white.png" class="navbar-logo" alt="GitHub link">
            <span class="github-label">See it on GitHub</span>
        </a>
    </nav>

    <div class="modal fade" id="filter-modal" tabindex="-1" role="dialog" aria-labelledby="filter-modal"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="flex-column">
                        <h5 class="modal-title" id="filter-modal">Filters</h5>
                        <h7 class="pl-2 text-secondary" id="variant-count">
                            <a href="javascript:resetFilter()">Reset All</a>
                        </h7>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="container">
                        <div class="row pt-2">
                            <div class="col">
                                <h5>Variant ID</h5>
                            </div>
                        </div>
                        <div class="row pb-3">
                            <div class="col-12">
                                <div id="variant-search"></div>
                            </div>
                        </div>
                        <div class="row pt-2">
                            <div class="col">
                                <h5>Sample</h5>
                            </div>
                        </div>
                        <div class="row pb-3">
                            <div class="col-12">
                                <div id="sample-search"></div>
                            </div>
                        </div>
                        <div class="row" id="nvariants-chart">
                            <div class="col-4">
                                <h5># of Variants</h5>
                            </div>
                            <div class="col-8 text-right">
                                <span class="reset text-muted" style="display: none;">[<span
                                        class="filter"></span>]</span>
                                <a class="reset" href="javascript:nvariantsChart.filterAll();dc.redrawAll();"
                                    style="display: none;">Reset</a>
                            </div>
                        </div>
                        <div class="row" id="size-chart">
                            <div class="col-4">
                                <h5>Size</h5>
                            </div>
                            <div class="col-8 text-right">
                                <span class="reset text-muted" style="display: none;">[<span
                                        class="filter"></span>]</span>
                                <a class="reset" href="javascript:sizeChart.filterAll();dc.redrawAll();"
                                    style="display: none;">Reset</a>
                            </div>
                        </div>
                        <div class="row" id="chrom-chart">
                            <div class="col-4">
                                <h5>Chromosome</h5>
                            </div>
                            <div class="col-8 text-right">
                                <span class="reset text-muted" style="display: none;">[<span
                                        class="filter"></span>]</span>
                                <a class="reset" href="javascript:chromChart.filterAll();dc.redrawAll();"
                                    style="display: none;">Reset</a>
                            </div>
                        </div>
                        <div class="row" id="overlaps-chart" hidden>
                            <div class="col-4">
                                <h5>SV Overlaps</h5>
                            </div>
                            <div class="col-8 text-right">
                                <span class="reset text-muted" style="display: none;">[<span
                                        class="filter"></span>]</span>
                                <a class="reset" href="javascript:overlapsChart.filterAll();dc.redrawAll();"
                                    style="display: none;">Reset</a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-dismiss="modal"
                        onclick="javascript:dc.filterAll(); dc.renderAll();"
                        title="Clear selection and close">Cancel</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal"
                        title="Apply filters">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid h-90">
        <div class="row" id="variant-table-placeholder">
            <div class="col-12">
                <div style="height:415px">
                    <div class="d-flex justify-content-center align-items-center text-muted h-100">
                        <div class="d-flex flex-column">
                            <i class="fas fa-10x fa-table"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row pb-1" id="variant-table-div" hidden>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="variant-table" class="table table-hover display nowrap" width="100%"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom context menu -->
    <div id="context-menu" class="custom-context-menu">
        <div class="context-menu-item" id="copy-image-url">Copy Image URL</div>
        <div class="context-menu-item" id="copy-page-url">Copy Page URL with Hash</div>
        <div class="context-menu-item" id="view-image">View Image</div>
    </div>

    <!-- Success message for clipboard operations -->
    <div class="clipboard-success">URL copied to clipboard!</div>
</body>

<script>
    const data = [{"chrom": "chr1", "chrom2": null, "end": 159006873, "image_name": "tmp_chr1-158883964-159006873", "nvariants": 0, "samples": "tmp", "start": 158883964, "svlength": 122909, "variant_ids": null}]
    const unique_data = [{"chrom": "chr1", "chrom2": null, "end": 159006873, "image_name": "tmp_chr1-158883964-159006873", "nvariants": 0, "samples": "tmp", "start": 158883964, "svlength": 122909, "variant_ids": null}]
    const plot_type = "png"

    dc.config.defaultColors(d3.schemeSet1)

    // plot constraints
    const plotw = 585
    const ploth = 150

    // table filters
    var searchInput = dc.textFilterWidget("#sample-search")
    var variantInput = dc.textFilterWidget("#variant-search")
    var nvariantsChart = dc.barChart("#nvariants-chart")
    var sizeChart = dc.barChart("#size-chart")
    var chromChart = dc.barChart("#chrom-chart")
    var overlapsChart
    // shows filter impact in modal header
    var variantCount = dc.dataCount("#variant-count")

    // used to access filtered table data
    var chromDimension
    // datatables obj
    var variant_table
    // crossfilter obj
    var ndx
    // dimensions
    var nvariantsDimension
    var searchDimension
    var variantDimension

    // Add this with other global variables at the top
    var isUniqueMode = false;

    let currentViewer = null;
    function handleKeyPress(event) {
        if (!currentViewer) return;

        // Prevent default scrolling behavior for left/right keys
        if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
            event.preventDefault();

            const current = $('tr.selected');
            if (!current.length) return;  // No row is selected

            // Get the current row index
            const currentRowIndex = variant_table.row(current).index();
            if (currentRowIndex === undefined) return;

            try {
                if (event.key === 'ArrowLeft' && currentRowIndex > 0) {
                    currentViewer.destroy();
                    currentViewer = null;
                    // Use the index directly for navigation
                    table_click(currentRowIndex - 1, variant_table);
                } else if (event.key === 'ArrowRight' && currentRowIndex < variant_table.rows().count() - 1) {
                    currentViewer.destroy();
                    currentViewer = null;
                    // Use the index directly for navigation
                    table_click(currentRowIndex + 1, variant_table);
                }
            } catch (error) {
                console.error("Error handling key navigation:", error);
                // Try to clean up if there was an error
                if (currentViewer) {
                    try {
                        currentViewer.destroy();
                    } catch (e) { /* ignore error during cleanup */ }
                    currentViewer = null;
                }
                // Remove the viewer-open class
                document.body.classList.remove('viewer-open');
            }
        }
    }

    $('#filter-modal').on('hidden.bs.modal', function () {
        update_table()
    })

    function showImageFromHash() {
        if (window.location.hash) {
            try {
                // Format is #chrom:start-end:sample
                const hash = window.location.hash.substring(1);
                console.log("Processing hash:", hash);

                // More permissive pattern matching to handle potential encoding issues
                const match = hash.match(/^([^:]+):(\d+)-(\d+):(.+)$/);

                if (match) {
                    const [_, chrom, startStr, endStr, sample] = match;
                    const start = parseInt(startStr);
                    const end = parseInt(endStr);

                    console.log("Parsed hash:", chrom, start, end, sample);

                    if (isNaN(start) || isNaN(end)) {
                        console.warn(`Invalid coordinates in hash: ${hash}`);
                        history.pushState(null, '', window.location.pathname);
                        return;
                    }

                    // Find the matching row
                    let foundRow = false;
                    let rowCount = 0;
                    let matchingRowIndex = -1;

                    console.log("Searching for matching row...");

                    variant_table.rows().every(function (rowIndex) {
                        rowCount++;
                        const data = this.data();

                        // Debugging
                        if (rowCount <= 5) {
                            console.log(`Row ${rowCount} data:`,
                                data.chrom, data.start, data.end, data.samples);
                        }

                        if (data.chrom === chrom &&
                            data.start === start &&
                            data.end === end &&
                            data.samples === sample) {
                            console.log("Found matching row:", rowCount);
                            matchingRowIndex = rowIndex;
                            foundRow = true;
                            return false; // break the loop
                        }
                        return true;
                    });

                    console.log(`Searched ${rowCount} rows, found match: ${foundRow}, at index: ${matchingRowIndex}`);

                    // Handle case where a matching row was found - use the index directly
                    if (foundRow && matchingRowIndex >= 0) {
                        // Use the row index directly - no need to find the DOM node
                        table_click(matchingRowIndex, variant_table);
                    } else {
                        console.warn(`No matching row found for ${chrom}:${start}-${end}:${sample}`);
                        // Clear the hash to prevent repeated errors
                        history.pushState(null, '', window.location.pathname);
                    }
                } else {
                    console.warn(`Hash does not match expected format: ${hash}`);
                    history.pushState(null, '', window.location.pathname);
                }
            } catch (error) {
                console.error("Error processing hash:", error);
                history.pushState(null, '', window.location.pathname);
            }
        }
    }

    const table_click = (selection, table) => {
        // Ensure we have a valid selection before proceeding
        if (!selection || !table) {
            console.warn("Invalid selection");
            return;
        }

        let rowIndex;

        // Handle both DOM nodes and direct row indices
        if (typeof selection === 'number') {
            // It's already a row index
            rowIndex = selection;
            console.log("Selection is a row index:", rowIndex);
        } else {
            // It's a DOM node
            rowIndex = table.row(selection).index();
            console.log("Selection is a DOM node, row index:", rowIndex);
        }

        if (rowIndex === undefined) {
            console.warn("Could not determine row index");
            return;
        }

        // Get row data before making any DOM changes
        const row = table.row(rowIndex).data();
        if (!row) {
            console.warn("Selected row has no data");
            return;
        }

        // Check if we have a valid row with the required properties
        if (!row.chrom || !row.start || !row.end || !row.samples || !row.image_name) {
            console.warn("Selected row is missing required data:",
                !row.chrom ? "chrom" : "",
                !row.start ? "start" : "",
                !row.end ? "end" : "",
                !row.samples ? "samples" : "",
                !row.image_name ? "image_name" : "");
            return;
        }

        // Try to get the DOM node for visual selection
        const rowNode = table.row(rowIndex).node();

        // Only update visual selection if we have a valid DOM node
        if (rowNode) {
            table.$('tr.selected').removeClass('selected');
            $(rowNode).addClass('selected');
        } else {
            console.log("Row node not available for visual selection");
        }

        // Get references to adjacent rows for navigation buttons
        const currentRowIndex = rowIndex; // Use the index we already determined
        const hasPrevRow = currentRowIndex > 0;
        const hasNextRow = currentRowIndex < table.rows().count() - 1;

        // Debugging
        console.log(`Loading image: ${row.image_name}.${plot_type}, Row: ${currentRowIndex}, Chrom: ${row.chrom}`);

        // Update URL hash with row information including sample
        window.history.pushState(null, '',
            `#${row.chrom}:${row.start}-${row.end}:${row.samples}`);

        let img = new Image()
        img.src = `${row.image_name}.${plot_type}`

        img.onerror = function () {
            console.error(`Image not found: ${img.src}`);
            alert(`${img.src} not found`);
        }

        img.onload = function () {
            console.log(`Image loaded successfully: ${img.src}`);
        }

        let viewer = new Viewer(img, {
            hidden: function () {
                document.removeEventListener('keydown', handleKeyPress);
                currentViewer = null;
                viewer.destroy();

                // Re-enable default browser keyboard behavior when viewer is closed
                document.body.classList.remove('viewer-open');
            },
            title: function () {
                return `chromosome ${row.chrom} at ${row.start}-${row.end}`
            },
            shown: function () {
                // Disable default browser keyboard behavior when viewer is open
                document.body.classList.add('viewer-open');
            },
            toolbar: {
                zoomIn: 4,
                zoomOut: 4,
                oneToOne: 4,
                reset: 4,
                prev: {
                    show: hasPrevRow,
                    size: "large",
                    click: function () {
                        try {
                            if (!hasPrevRow) return;

                            viewer.destroy();
                            currentViewer = null;

                            // Use the index directly for the previous row
                            table_click(currentRowIndex - 1, table);
                        } catch (error) {
                            console.error("Error navigating to previous image:", error);
                            // Try to clean up
                            try {
                                viewer.destroy();
                            } catch (e) { /* ignore error during cleanup */ }
                            currentViewer = null;
                        }
                    }
                },
                play: { show: false },
                next: {
                    show: hasNextRow,
                    size: "large",
                    click: function () {
                        try {
                            if (!hasNextRow) return;

                            viewer.destroy();
                            currentViewer = null;

                            // Use the index directly for the next row
                            table_click(currentRowIndex + 1, table);
                        } catch (error) {
                            console.error("Error navigating to next image:", error);
                            // Try to clean up
                            try {
                                viewer.destroy();
                            } catch (e) { /* ignore error during cleanup */ }
                            currentViewer = null;
                        }
                    }
                },
                rotateLeft: { show: false },
                rotateRight: { show: false },
                flipHorizontal: { show: false },
                flipVertical: { show: false },
            },
            transition: false,
            navbar: false,
        })

        // Add the event listener when viewer is shown
        currentViewer = viewer;
        document.addEventListener('keydown', handleKeyPress);

        console.log("Showing viewer");
        viewer.show()
    }


    function build_table(data) {
        // hide the placeholder and show the datatable
        d3.select('#variant-table-placeholder').property("hidden", true)
        d3.select('#variant-table-div').property("hidden", false)

        let cols = [
            { data: 'chrom', title: 'Chrom' },
            { data: 'start', title: 'Start' },
            { data: 'end', title: 'End' },
            { data: 'svlength', title: 'Size' },
            { data: 'samples', title: 'Sample' },
            { data: 'variant_ids', title: 'Variant IDs' },
            { data: 'nvariants', title: '# of Variants' },
        ]

        variant_table = $("#variant-table").DataTable({
            data: data,
            columns: cols,
            deferRender: true,
            scrollY: '80vh',
            scrollCollapse: true,
            scroller: {
                loadingIndicator: true,
                displayBuffer: 20,
                serverWait: 100
            },
            info: true,
            buttons: [
                {
                    extend: 'copyHtml5',
                    fieldSeparator: '\t',
                    fieldBoundary: '',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6],
                        format: {
                            // Special handling for columns with HTML wrappers
                            body: function (data, row, column, node) {
                                // Get the raw data from the row
                                const rowData = variant_table.row(row).data();

                                // For Sample column (index 4)
                                if (column === 4) {
                                    return rowData.samples;
                                }
                                // For variant IDs column (index 5)
                                else if (column === 5) {
                                    const variantData = rowData.variant_ids;
                                    return Array.isArray(variantData) ? variantData.join(', ') : variantData;
                                }
                                // For # of Variants column (index 6)
                                else if (column === 6) {
                                    return rowData.nvariants;
                                }
                                return data;
                            }
                        }
                    }
                },
                {
                    extend: 'csvHtml5',
                    fieldSeparator: '\t',
                    fieldBoundary: '',
                    extension: '.tsv',
                    filename: 'svtopo_variants',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5, 6],
                        format: {
                            // Special handling for columns with HTML wrappers
                            body: function (data, row, column, node) {
                                // Get the raw data from the row
                                const rowData = variant_table.row(row).data();

                                // For Sample column (index 4)
                                if (column === 4) {
                                    return rowData.samples;
                                }
                                // For variant IDs column (index 5)
                                else if (column === 5) {
                                    const variantData = rowData.variant_ids;
                                    return Array.isArray(variantData) ? variantData.join(', ') : variantData;
                                }
                                // For # of Variants column (index 6)
                                else if (column === 6) {
                                    return rowData.nvariants;
                                }
                                return data;
                            }
                        }
                    }
                }
            ],
            dom: 'Brti',
            // Hide the buttons container but keep it in the DOM
            initComplete: function () {
                $('.dt-buttons').hide();

                // Process hash URL only after table is fully initialized
                setTimeout(function () {
                    showImageFromHash();
                }, 200);
            },
            infoCallback: (oSettings, iStart, iEnd, iMax, iTotal, sPre) => {
                return `
            <span class="datatable-info"> 
                <span class="pr-2">Showing <b>${iStart}</b> - <b>${iEnd}</b> of <b>${iTotal}</b> records</span>
                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#filter-modal" title="Show filters">
                    <span class="fas fa-filter"></span>
                </button>
                <button type="button" class="btn btn-primary btn-sm mr-2" onclick="resetFilter()" title="Reset variant filter">
                    <span class="fas fa-undo"></span>
                </button>
                <span class="dropup">
                    <button type="button" class="btn btn-sm btn-primary dropdown-toggle" id="download-menu" title="Save table" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <span class="fas fa-save"></span>
                    </button>
                    <span class="dropdown-menu" aria-labelledby="download-menu">
                        <h6 class="dropdown-header">Save ${iTotal} rows as:</h6>
                        <button class="dropdown-item" type="button" id="tsv-button-download" onclick="tsv_button_click()">
                            TSV
                        </button>
                        <button class="dropdown-item" type="button" id="copy-button-download" onclick="copy_button_click()">
                            Copy
                        </button>
                    </span>
                </span>
                <div class="custom-control custom-checkbox d-inline-block ml-2">
                    <input type="checkbox" class="custom-control-input" id="uniqueToggle"${isUniqueMode ? ' checked' : ''}>
                    <label class="custom-control-label" for="uniqueToggle">Show multi-region entries only once</label>
                </div>
            </span>
            `
            },
            columnDefs: [
                {
                    targets: ([0, 1, 2, 3]),
                },
                {
                    targets: 4,  // Sample column
                    render: function (data, type, row) {
                        if (type === 'display' && data != null) {
                            return `<a href="#" onclick="filterBySample('${data}', event)" style="color: inherit; text-decoration: none;">${data}</a>`;
                        }
                        return data;
                    }
                },
                {
                    targets: 5,  // Variant IDs column
                    render: function (data, type, row) {
                        if (type === 'display' && data != null) {
                            let variantList = Array.isArray(data) ? data : [data];
                            let maxDisplay = 4;  // Maximum number of variants to display
                            let displayText = variantList.length > maxDisplay ?
                                variantList.slice(0, maxDisplay).join(', ') + '...' :
                                variantList.join(', ');

                            let dropdownItems = variantList.map(id =>
                                `<a class="dropdown-item" onclick="filterByVariantId('${id}', event)">${id}</a>`
                            ).join('');

                            return `<div class="dropdown">
                                <span>${displayText}</span>
                                <div class="dropdown-content">
                                    ${dropdownItems}
                                </div>
                            </div>`;
                        }
                        return Array.isArray(data) ? data.join(', ') : data;
                    }
                },
                {
                    targets: 6,  // # of Variants column
                    render: function (data, type, row) {
                        if (type === 'display' && data != null) {
                            return `<a href="#" onclick="filterByNVariants(${data}, event)" style="color: inherit; text-decoration: none;">${data}</a>`;
                        }
                        return data;
                    }
                }
            ],
            lengthChange: false,
            order: [[0, 'asc'], [1, 'asc']],
            rowId: function (data) {
                return `row-${data.chrom}-${data.start}-${data.end}-${data.samples.replace(/\s+/g, '-')}`;
            },
        })

        // Move the handler outside build_table, at the same level as other event handlers
        $(document).on('change', '#uniqueToggle', function () {
            isUniqueMode = this.checked;
            console.log('Toggle clicked, unique mode:', isUniqueMode);
            // Reset the crossfilter with new data
            ndx.remove();
            ndx.add(isUniqueMode ? unique_data : data);

            // Recreate dimensions using the helper function
            const dims = createDimensions(ndx);
            chromDimension = dims.chrom;
            nvariantsDimension = dims.nvariants;
            searchDimension = dims.search;
            variantDimension = dims.variant;

            // Reset filters and update everything
            dc.filterAll();
            dc.renderAll();

            // Update the table with new data
            update_table();
        });

        // register table clicks on sample_column
        variant_table.on('click', 'tr', function () {
            table_click(this, variant_table)
        })

        // Handle context menu (right-click)
        setupContextMenu();
    }

    function tsv_button_click() {
        // Get all data that passes the current filters
        let filteredData = [];
        variant_table.rows({ search: 'applied' }).every(function () {
            const rowData = this.data();
            filteredData.push([
                rowData.chrom,
                rowData.start,
                rowData.end,
                rowData.svlength,
                rowData.samples,
                Array.isArray(rowData.variant_ids) ? rowData.variant_ids.join(', ') : rowData.variant_ids,
                rowData.nvariants
            ]);
        });

        // Create TSV content
        let tsvContent = "Chrom\tStart\tEnd\tSize\tSample\tVariant IDs\t# of Variants\n";
        filteredData.forEach(row => {
            tsvContent += row.join('\t') + '\n';
        });

        // Create and trigger download
        const blob = new Blob([tsvContent], { type: 'text/tab-separated-values' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = 'svtopo_variants.tsv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function copy_button_click() {
        // Get all data that passes the current filters
        let filteredData = [];
        variant_table.rows({ search: 'applied' }).every(function () {
            const rowData = this.data();
            filteredData.push([
                rowData.chrom,
                rowData.start,
                rowData.end,
                rowData.svlength,
                rowData.samples,
                Array.isArray(rowData.variant_ids) ? rowData.variant_ids.join(', ') : rowData.variant_ids,
                rowData.nvariants
            ]);
        });

        // Create TSV content for clipboard
        let tsvContent = "Chrom\tStart\tEnd\tSize\tSample\tVariant IDs\t# of Variants\n";
        filteredData.forEach(row => {
            tsvContent += row.join('\t') + '\n';
        });

        // Copy to clipboard
        const textarea = document.createElement('textarea');
        textarea.value = tsvContent;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);

        // Show a notification that data was copied
        alert(`Copied ${filteredData.length} rows to clipboard`);
    }

    function update_table() {
        variant_table.clear()
        variant_table.rows.add(chromDimension.top(Infinity))
        variant_table.draw()
    }

    function remove_empty_bins(source_group) {
        return {
            all: function () {
                return source_group.all().filter(function (d) {
                    return d.value != 0
                })
            }
        }
    }

    // https://jsfiddle.net/gordonwoodhull/g34Ldwaz/8/
    // https://github.com/dc-js/dc.js/issues/348
    function index_group(group) {
        return {
            all: function () {
                return group.all().map(function (kv, i) {
                    return { key: i, value: kv.value }
                })
            }
        }
    }

    // Function to create all dimensions
    function createDimensions(ndx) {
        return {
            chrom: ndx.dimension(d => d.chrom),
            nvariants: ndx.dimension(d => {
                const round = d.nvariants < 10 ? 1 :
                    d.nvariants < 100 ? 10 :
                        d.nvariants < 1000 ? 100 :
                            d.nvariants < 10000 ? 1000 : 10000;
                return Math.round(d.nvariants / round) * round;
            }),
            search: ndx.dimension(d => d.samples),
            variant: ndx.dimension(d => Array.isArray(d.variant_ids) ? d.variant_ids.join(' ') : d.variant_ids)
        };
    }

    $(document).ready(function () {
        // Wrap in try-catch to handle potential errors during initialization
        try {
            ndx = crossfilter(data)
            var all = ndx.groupAll()

            // Initial dimension creation using the helper function
            const dims = createDimensions(ndx);
            chromDimension = dims.chrom;
            nvariantsDimension = dims.nvariants;
            searchDimension = dims.search;
            variantDimension = dims.variant;

            build_table(chromDimension.top(Infinity))
            var chromGroup = chromDimension.group().reduceCount()
            var nonEmptyChromGroup = remove_empty_bins(chromGroup)

            searchInput
                .dimension(searchDimension)
                .on('renderlet', function () {
                    d3.selectAll(".dc-text-filter-input")
                        .classed("form-control", true)
                    d3.selectAll("#sample-search.dc-chart")
                        .classed("col-12", true)
                })

            variantInput
                .dimension(variantDimension)
                .on('renderlet', function () {
                    d3.selectAll(".dc-text-filter-input")
                        .classed("form-control", true)
                    d3.selectAll("#variant-search.dc-chart")
                        .classed("col-12", true)
                })

            var sizeDimension = ndx.dimension(function (d) {
                var round
                if (d.svlength < 100) {
                    round = 100
                } else if (d.svlength < 1000) {
                    round = 100
                } else if (d.svlength < 10000) {
                    round = 1000
                } else if (d.svlength < 100000) {
                    round = 10000
                } else if (d.svlength < 1000000) {
                    round = 100000
                } else if (d.svlength < 10000000) {
                    round = 1000000
                } else {
                    round = 10000000
                }
                return Math.round(d.svlength / round) * round
            })
            var sizeGroup = sizeDimension.group().reduceCount()
            var nonEmptySizeGroup = remove_empty_bins(sizeGroup)
            // for brushing, need to track keys at numeric indexes
            var sizeKeys = nonEmptySizeGroup.all().map(dc.pluck('key')).slice()
            var nvariantsGroup = nvariantsDimension.group().reduceCount()
            var nonEmptyNvariantsGroup = remove_empty_bins(nvariantsGroup)
            var nvariantsKeys = nonEmptyNvariantsGroup.all().map(dc.pluck('key')).slice()

            // number of variants
            nvariantsChart
                .width(plotw).height(ploth).gap(1)
                .margins({ top: 10, right: 50, bottom: 30, left: 40 })
                .x(d3.scaleLinear().domain([0, nvariantsKeys.length]))
                .round(Math.floor)
                .brushOn(true)
                .elasticX(true)
                .dimension(nvariantsDimension)
                .group(index_group(nonEmptyNvariantsGroup))
                .elasticY(true)
                .yAxisLabel('Count')
                .filterPrinter(function (filters) {
                    var filter = filters[0]
                    return nvariantsKeys[filter[0]] + ' - ' + nvariantsKeys[filter[1]]
                })
            // limit the number of labels along x-axis
            nvariantsChart.xAxis().ticks(20)
            nvariantsChart.yAxis().ticks(5)
            // update labels from keys
            nvariantsChart.xAxis().tickFormat(function (v) {
                return nvariantsKeys[v]
            })
            nvariantsChart.filterHandler(function (dimension, filters) {
                if (filters.length === 0) {
                    // the empty case (no filtering)
                    dimension.filter(null);
                } else {
                    const range = [nvariantsKeys[filters[0][0]], nvariantsKeys[filters[0][1]]];
                    dimension.filterRange(range);
                }
                return filters;
            });

            // SV length
            sizeChart
                .width(plotw).height(ploth).gap(1)
                .margins({ top: 10, right: 50, bottom: 30, left: 40 })
                .x(d3.scaleLinear().domain([0, sizeKeys.length]))
                .round(Math.floor)
                .brushOn(true)
                .elasticX(true)
                .dimension(sizeDimension)
                .group(index_group(nonEmptySizeGroup))
                .elasticY(true)
                .yAxisLabel('Count')
                .filterPrinter(function (filters) {
                    var filter = filters[0]
                    return sizeKeys[filter[0]] + ' - ' + sizeKeys[filter[1]]
                })
                // adds left padding to plots inside filtering panel
                .on('renderlet', function () {
                    d3.selectAll("svg")
                        .classed("pl-3", true)
                })
            // limit the number of labels along x-axis
            sizeChart.xAxis().ticks(10)
            sizeChart.yAxis().ticks(5)
            // update labels from keys
            sizeChart.xAxis().tickFormat(function (v) {
                return sizeKeys[v]
            })
            // update the status format for this chart
            sizeChart.filterHandler(function (dimension, filters) {
                if (filters.length === 0) {
                    // the empty case (no filtering)
                    dimension.filter(null)
                } else {
                    dimension.filterRange([sizeKeys[filters[0][0]], sizeKeys[filters[0][1]]])
                }
                return filters
            })

            // chromosome
            chromChart
                .width(plotw).height(ploth).gap(1)
                .margins({ top: 10, right: 50, bottom: 70, left: 40 })
                .x(d3.scaleBand())
                .xUnits(dc.units.ordinal)
                .yAxisLabel('Count')
                .elasticX(true)
                .elasticY(true)
                .dimension(chromDimension)
                .group(nonEmptyChromGroup)
                .ordering((d) => {
                    // Strip out 'chr' prefix if it exists
                    let key = d.key.toLowerCase().replace('chr', '');
                    let v = parseInt(key);
                    if (v) {
                        return v;
                    } else {
                        // Handle special cases like 'X', 'Y', 'M'
                        if (key === 'x') return 23;
                        if (key === 'y') return 24;
                        if (key === 'm' || key === 'mt') return 25;
                        return key;
                    }
                })
                .on('renderlet', function (chart) {
                    chart.selectAll('g.x text')
                        .attr('transform', 'rotate(90)')
                        .attr('text-anchor', 'start')
                        .attr('y', -5)
                        .attr('x', 10);
                });
            chromChart.yAxis().ticks(5)

            variantCount
                .dimension(ndx)
                .group(all)
                .html({
                    some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> records' +
                        ' | <a href=\'javascript:resetFilter()\'>Reset All</a>',
                    all: '<strong>%total-count</strong> records'
                });

            dc.renderAll()

            // Note: Handled by table's initComplete function
            // No need to call showImageFromHash() here
        } catch (error) {
            console.error("Error initializing application:", error);
        }
    })

    function filterByVariantId(variantId, event) {
        event.stopPropagation();

        // Add custom search function
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                let variantIds = data[5].split(', '); // Column 5 is Variant IDs (after reordering)
                return variantIds.includes(variantId);
            }
        );

        variant_table.draw();

        // Remove the custom search function
        $.fn.dataTable.ext.search.pop();
    }

    function resetFilter() {
        // Reset DC.js filters
        dc.filterAll();

        // Clear any DataTables search filters
        variant_table.search('').columns().search('');

        // Clear any custom search functions that might have been added
        while ($.fn.dataTable.ext.search.length > 0) {
            $.fn.dataTable.ext.search.pop();
        }

        // Reset DataTable and update with unfiltered data
        variant_table.clear();

        // Use the appropriate data source based on unique mode
        const sourceData = isUniqueMode ? unique_data : data;

        // Reset the crossfilter with the appropriate data
        ndx.remove();
        ndx.add(sourceData);

        // Recreate dimensions
        const dims = createDimensions(ndx);
        chromDimension = dims.chrom;
        nvariantsDimension = dims.nvariants;
        searchDimension = dims.search;
        variantDimension = dims.variant;

        // Redraw all DC charts to ensure filters are visually reset
        dc.redrawAll();

        // Update the table with the appropriate data
        variant_table.rows.add(chromDimension.top(Infinity));
        variant_table.draw();

        // Clear the URL hash without triggering a page reload
        history.pushState(null, '', window.location.pathname);

        // Reset the sample search input field
        let searchInput = document.querySelector("#sample-search .dc-text-filter-input");
        if (searchInput) searchInput.value = '';

        // Reset the variant search input field
        let variantInput = document.querySelector("#variant-search .dc-text-filter-input");
        if (variantInput) variantInput.value = '';
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function (event) {
        showImageFromHash();
    });

    function filterBySample(sample, event) {
        event.preventDefault();
        event.stopPropagation();

        // Add custom search function for exact sample match
        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                return data[4] === sample; // Column 4 is Sample
            }
        );

        // Update the sample search input for visual feedback
        let searchInput = document.querySelector("#sample-search .dc-text-filter-input");
        if (searchInput) searchInput.value = sample;

        // Apply the filter
        variant_table.draw();
    }

    function filterByNVariants(nvariants, event) {
        event.preventDefault();
        event.stopPropagation();

        // Apply the filter for exact match
        nvariantsDimension.filter(nvariants);

        // Redraw all charts to ensure UI consistency
        dc.redrawAll();

        // Update the table with filtered data
        update_table();
    }

    // Setup context menu functionality
    function setupContextMenu() {
        const contextMenu = document.getElementById('context-menu');
        const copyImageUrlItem = document.getElementById('copy-image-url');
        const copyPageUrlItem = document.getElementById('copy-page-url');
        const viewImageItem = document.getElementById('view-image');

        // Prevent default context menu
        document.querySelector('#variant-table').addEventListener('contextmenu', function (e) {
            e.preventDefault();

            // Get the closest tr element (table row)
            const tr = $(e.target).closest('tr')[0];
            if (!tr) return;

            // Get the data for this row
            const rowData = variant_table.row(tr).data();
            if (!rowData) return;

            // Position the context menu
            contextMenu.style.top = `${e.pageY}px`;
            contextMenu.style.left = `${e.pageX}px`;
            contextMenu.style.display = 'block';

            // Store reference to the row for use in menu item clicks
            contextMenu.dataset.rowId = tr.id;
        });

        // Hide context menu when clicking outside
        document.addEventListener('click', function () {
            contextMenu.style.display = 'none';
        });

        // Copy Image URL menu item
        copyImageUrlItem.addEventListener('click', function () {
            const tr = document.getElementById(contextMenu.dataset.rowId);
            if (!tr) return;

            const rowData = variant_table.row(tr).data();
            if (!rowData || !rowData.image_name) return;

            // Create the image URL
            const imageUrl = `${window.location.origin}${window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1)}${rowData.image_name}.${plot_type}`;

            // Copy to clipboard
            copyToClipboard(imageUrl);
        });

        // Copy Page URL with hash
        copyPageUrlItem.addEventListener('click', function () {
            const tr = document.getElementById(contextMenu.dataset.rowId);
            if (!tr) return;

            const rowData = variant_table.row(tr).data();
            if (!rowData || !rowData.chrom || !rowData.start || !rowData.end || !rowData.samples) return;

            // Create the page URL with hash
            const hash = `#${rowData.chrom}:${rowData.start}-${rowData.end}:${rowData.samples}`;
            const pageUrl = `${window.location.origin}${window.location.pathname}${hash}`;

            // Copy to clipboard
            copyToClipboard(pageUrl);
        });

        // View image menu item
        viewImageItem.addEventListener('click', function () {
            try {
                const tr = document.getElementById(contextMenu.dataset.rowId);
                if (!tr) {
                    console.warn("No table row found with ID:", contextMenu.dataset.rowId);
                    return;
                }

                console.log("Context menu: viewing image for row", contextMenu.dataset.rowId);

                // Trigger the same action as clicking the row
                table_click(tr, variant_table);
            } catch (error) {
                console.error("Error handling view image action:", error);
            }
        });
    }

    // Helper function to copy text to clipboard
    function copyToClipboard(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                // Show success message
                const successMsg = document.querySelector('.clipboard-success');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 2000);
            }
        } catch (err) {
            console.error('Unable to copy to clipboard', err);
            alert('Failed to copy URL to clipboard');
        }

        document.body.removeChild(textarea);
    }
</script>

</html>
